FROM golang:1.18.1-alpine AS build

ENV TRIVYVERSION=v0.22.0

WORKDIR /src/

RUN apk add --update --no-cache curl git
RUN curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /bin ${TRIVYVERSION}

COPY go.mod .
COPY go.sum .
RUN go mod tidy && go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o /bin/trivy-vulnerability-exporter

FROM alpine:3.16.2
COPY --from=build /bin/trivy-vulnerability-exporter /bin/trivy-vulnerability-exporter
COPY --from=build /bin/trivy /usr/local/bin/trivy
ENTRYPOINT ["/bin/trivy-vulnerability-exporter"]
